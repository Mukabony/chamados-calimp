use SANKHYA_TESTE
GO

WITH CTE_BASE AS (
    SELECT 
        RE.*,
        CAB.CODVEND,
        PAR.AD_PZOTRANSPORTE,
        -- Definir o NUNOTA de referÃªncia para cada linha
        CASE 
            WHEN RE.TIPMOV = 'V' THEN RE.NUNOTA
            ELSE (
                SELECT TOP 1 VAR.NUNOTA 
                FROM sankhya.TGFVAR VAR 
                WHERE VAR.NUNOTAORIG = RE.NUNOTA
            )
        END AS NUNOTA_REF
    FROM sankhya.AD_ROTEIROENTREGA RE
    JOIN sankhya.TGFCAB CAB ON RE.NUNOTA = CAB.NUNOTA
    JOIN sankhya.TGFPAR PAR ON CAB.CODPARC = PAR.CODPARC
    WHERE CONVERT(DATE, RE.DTROTEIRO) >= '01/06/2024'
      AND CONVERT(DATE, RE.DTROTEIRO) < CONVERT(DATE, GETDATE())
      AND RE.DTENTREGACLIENTE IS NULL
),
CTE_NOTA AS (
    SELECT 
        NUNOTA_REF,
        NF.NUMNOTA,
        NF.DTNEG
    FROM (
        SELECT DISTINCT NUNOTA_REF FROM CTE_BASE
    ) X
    LEFT JOIN sankhya.TGFCAB NF ON NF.NUNOTA = X.NUNOTA_REF
),
CTE_VCTO_BOLETO AS (
    SELECT 
        NUNOTA_REF,
        MIN(TGFFIN.DTVENC) AS DTVENC
    FROM CTE_BASE
    LEFT JOIN sankhya.TGFFIN ON TGFFIN.NUNOTA = CTE_BASE.NUNOTA_REF
    GROUP BY NUNOTA_REF
)
SELECT
    N.NUMNOTA AS 'N_NOTA',
    N.DTNEG AS 'DT_EMISSAO',
    B.DTROTEIRO AS 'DT_ROTEIRO',
    B.PREVENTREGA AS 'PREV_ENTREGA',
    B.DTTRANSPORTADORA AS 'DT_ENTREGA_TRANSPORTADORA',
    ISNULL(B.AD_PZOTRANSPORTE,0) AS 'PZO_ENTREGA',
    ((CASE WHEN (B.DTTRANSPORTADORA IS NULL) THEN B.DTROTEIRO ELSE B.DTTRANSPORTADORA END)
        + ISNULL(B.AD_PZOTRANSPORTE,0) + 1) AS 'DT_PREVISTA_CLIENTE',
    CONVERT(INT,(CONVERT(DATETIME,CONVERT(DATE,GETDATE())) -
        ((CASE WHEN (B.DTTRANSPORTADORA IS NULL) THEN B.DTROTEIRO ELSE B.DTTRANSPORTADORA END)
        + ISNULL(B.AD_PZOTRANSPORTE,0) + 1))) AS 'DIAS_ATRASO',
    CONVERT(DATETIME,CONVERT(DATE,GETDATE())) AS 'DT_HOJE',
    VBO.DTVENC AS 'VCTO_BOLETO',
    LTRIM(RTRIM(B.PARCEIRO)) AS 'PARCEIRO',
    (SELECT LTRIM(RTRIM(V.APELIDO))+' - '+CONVERT(VARCHAR,V.CODVEND)
        FROM sankhya.TGFVEN V WHERE V.CODVEND= B.CODVEND) AS 'REPRESENTANTE',
    LTRIM(RTRIM(B.TRANSPORTADORA)) AS 'TRANSPORTADORA',
    (REPLACE(REPLACE(LTRIM(RTRIM(CONVERT(VARCHAR(MAX),B.OBSERVACAO))) , CHAR(13) + CHAR(10), ''), CHAR (10), '')) AS 'OBSERVACAO'
FROM CTE_BASE B
LEFT JOIN CTE_NOTA N ON N.NUNOTA_REF = B.NUNOTA_REF
LEFT JOIN CTE_VCTO_BOLETO VBO ON VBO.NUNOTA_REF = B.NUNOTA_REF
WHERE (CONVERT(INT,(CONVERT(DATETIME,CONVERT(DATE,GETDATE())) -
        ((CASE WHEN (B.DTTRANSPORTADORA IS NULL) THEN B.DTROTEIRO ELSE B.DTTRANSPORTADORA END)
        + ISNULL(B.AD_PZOTRANSPORTE,0))))) > 0
ORDER BY 8 DESC, 1;